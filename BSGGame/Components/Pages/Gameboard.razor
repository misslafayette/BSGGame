@rendermode InteractiveServer
@using System;
@using System.Collections.Generic;
@using System.Linq;
@using BSGGame.GameLogic;
@using BSGGame.GameLogic.Cards;
@using BSGGame.GameLogic.Cards.Core;
@using BSGGame.GameLogic.Cards.Daybreak;
@using BSGGame.GameLogic.Cards.Exodus;
@using BSGGame.GameLogic.Cards.Pegasus;
@page "/gameboard"

<h1>🚀 Game Board</h1>

<p>Select a location:</p>

<div class="grid grid-cols-3 gap-3">
    <button class="btn btn-primary">Command</button>
    <button class="btn btn-primary">Research Lab</button>
    <button class="btn btn-primary">Sickbay</button>
    <button class="btn btn-primary">Brig</button>
</div>

<div class="top-row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
    @foreach (var player in players)
    {
        <div class="col">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h5 class="card-title">
                        @player.Name @if (player.HasDrawn) {
                        <span>👏</span>
                        <p>HasDrawn: @player.HasDrawn</p>
                    }
                    </h5>
                    <p class= "card-text">
                        Loyalty: <strong>@player.Loyalty</strong>
                    </p>
                    <button class="btn btn-outline-primary" @onclick="() => DrawCardOfType(player, CardType.Tactics)">Draw Tactics</button>
                    <button class="btn btn-outline-primary" @onclick="() => DrawCardOfType(player, CardType.Politics)">Draw Politics</button>
                    <button class="btn btn-outline-primary" @onclick="() => DrawCardOfType(player, CardType.Leadership)">Draw Leadership</button>
                    <button class="btn btn-outline-primary" @onclick="() => DrawCardOfType(player, CardType.Engineering)">Draw Engineering</button>
                    <button class="btn btn-outline-primary" @onclick="() => DrawCardOfType(player, CardType.Piloting)">Draw Piloting</button>

                    @if (player.Cards.Any())
                    {
                        var last = GetLastCard(player);

                        <p class="cards-drawn">
                            Drew: <span class="badge bg-info">@last?.Type</span> - <strong>@last?.Value</strong>
                        </p>

                        <div class="mt-3">
                            <h6>Hand:</h6>
                            <ul class="list-unstyled">
                                @foreach (var card in player.Cards)
                                {
                                    <li>
                                        <span class="badge bg-info">@card.Type</span> - <strong>@card.Value</strong>
                                    </li>
                                    <button class="btn btn-outline-primary" @onclick="() => DiscardCard(player,card)">Discard</button>
                                }
                            </ul>
                        </div>
                    }
                </div>
            </div>
        </div>
    }
</div>

<div class="container mt-5">
    <h4>🗑 Discard Piles</h4>
    @foreach (var pair in discardPiles)
    {
        <h5>@pair.Key</h5>
        <ul>
            @foreach (var card in pair.Value)
            {
                <li>@card.Type - @card.Value</li>
            }
        </ul>
    }
</div>

@code {
    Dictionary<CardType, List<SkillCard>> decks = new();
    void DrawCardOfType(Player player, CardType type)
    {
        if (!decks.TryGetValue(type, out var deckForType) || deckForType.Count == 0)
            return;

        var card = deckForType[0];
        deckForType.RemoveAt(0);

        player.Cards.Add(card);
        player.HasDrawn = true;

        Console.WriteLine($"Drew {card.Type} ({card.Value}) for {player.Name}");
        StateHasChanged();
    }

    void DiscardCard(Player player, SkillCard card)
    {
        if (player.Cards.Contains(card))
        {
            player.Cards.Remove(card);
            discardPiles[card.Type].Add(card);
        }

        StateHasChanged();
    }

    List<Player> players = new();

    protected override void OnInitialized()
    {
        players.AddRange(new[]
        {
            new Player {Name = "Adama", Loyalty = Loyalty.Human},
            new Player {Name = "Boomer", Loyalty = Loyalty.Cylon},
            new Player {Name = "Starbuck", Loyalty = Loyalty.Human}
        });

        foreach (CardType type in Enum.GetValues<CardType>())
        {
            decks[type] = new List<SkillCard>();
            discardPiles[type] = new List<SkillCard>();
        }

        void AddCards<T>(CardType type, int value, int count) where T : SkillCard
        {
            for (int i = 0; i < count; i++)
            {
                decks[type].Add((T)Activator.CreateInstance(typeof(T), value)!);
            }
        }

        AddCards<ExecutiveOrderCard>(CardType.Leadership, 1, 8);

        foreach (var deck in decks.Values)
        {
            deck.Shuffle();
        }
    }

    Dictionary<CardType, List<SkillCard>> discardPiles = new();

    SkillCard? GetLastCard(Player player)
    {
        return player.Cards.LastOrDefault();
    }
}